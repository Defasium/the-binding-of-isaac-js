<!DOCTYPE html>
<html>
<head>
<title>Les aventures de Joe le perdu</title>
<BODY bgcolor="black" text="white" onload="return fen_onload()">
</head>

<script type="text/javascript">

/*
	Variable commence par une lettre majuscule sauf celle qui représente des boutons(btn), image( img ) etc....
	fonction commence par une lettre minuscule et la suite est en majuscule
*/

// Image
var imgJoueurDroite = 0;
var imgJoueurGauche = 0;
var imgPaysage = 0;
var imgGem = 0;
var imgJoueurCourseGauche = 0;
var imgJoueurCourseDroite = 0;
var TabimgCiel = new Array(2);
var TabimgTerrain = new Array(2);

//resolution du Canevas
var ResolutionX = 0, ResolutionY = 0;

var DonneeNiveau = new Array(40);
	
//Envoyer les événements dans le jeu
var ToucheSautEnfoncer = false;
var ToucheGaucheEnfoncer = false;
var ToucheDroiteEnfoncer = false;

//variable concernant le joueur 
var VitesseMaximale = 4, JoueurEnVie = true;
var ForceX = 0, ForceY = 0;
var OrientationJoueur = 1;
var DeplacementX = 0, DeplacementY = 0;
var PositionJoueurTableauGaucheX = 0, PositionJoueurTableauDroiteX = 0, PositionJoueurTableauHautY = 0, PositionJoueurTableauBasY = 0;
var PositionJoueurCanevasX = 0, PositionJoueurCanevasY = 0;

// Variable de resultat
var Resultat = 0;
var NombreDiamant = 0,NombreDiamantCollecte = 0 ;

var Gravite = 0;	

//variable pour le niveau
var GrosseurTuile = 0;	
var LargeurNiveau = 0;
var HauteurNiveau = 0;
var GraviteCarte = 0.1;
var InformationNiveau =
'                     K\
                     K\
                     K\
           F         K\
         JJJ         K\
    JJJ  F           K\
                     K\
          J          K\
       JJ            K\
 JJJ                 K\
     J               K\
 1        JJ   F     K\
      JJJ     JJJ    K\
   JJJ               K\
JJJ                  K'	  


//---------------------------------------------------------------------------------------------- OK
function fen_onload()
{
	initialiserJeu();
}
//---------------------------------------------------------------------------------------------- OK
function initialiserJeu()
{	
	initialiserVariableNiveau();
	initialiserImage();

	ajouterEvenement();
	chargerNiveau();
	
	//lancer la boucle de jeu
	setInterval( "boucleJeu()" , 16.7);	// go
}

//---------------------------------------------------------------------------------------------- OK à donner
function ajouterEvenement()
{
	if (!document.addEventListener && document.attachEvent)
	{
		// IE
		document.attachEvent('onkeydown', gererToucherEnfoncer)
		document.attachEvent('onkeyup', gererToucherRelacher)
	}
	else 
	{
		window.addEventListener('keydown', gererToucherEnfoncer, true)
		window.addEventListener('keyup', gererToucherRelacher, true)
	}
}
//---------------------------------------------------------------------------------------------- OK étudiant

function initialiserImage()
{
	imgJoueurDroite = chargerImage('img/idle_right.png');
	imgJoueurGauche = chargerImage('img/idle_left.png');
	imgJoueurCourseGauche = chargerImage('img/run_right.png');
	imgJoueurCourseDroite = chargerImage('img/run_left.png');
	TabimgTerrain[0] = chargerImage('img/tiles_g.png');
	TabimgTerrain[1] = chargerImage('img/tiles.png');
	TabimgCiel[0] = chargerImage('img/jsplatformer4_b1.png');
	TabimgCiel[1] = chargerImage('img/jsplatformer4_b0.png');
	imgGem = chargerImage('img/gem.png');
}
//---------------------------------------------------------------------------------------------- OK
function initialiserVariableNiveau()
{
	var canvas = document.getElementById('canvas');

	DeplacementX = 0;
	LargeurNiveau = 22;
    HauteurNiveau = 15;
	ResolutionX = canvas.width;
	ResolutionY = canvas.height;
	
	//
	GrosseurTuile = ResolutionY / HauteurNiveau;
	for (var i = 0; i < DonneeNiveau.length; i++)
		DonneeNiveau[i] = new Array(HauteurNiveau);
}

//---------------------------------------------------------------------------------------------- OK, donner
function chargerImage( source )
{
	var img = new Image();
	img.src = source;
	return img;
}

//---------------------------------------------------------------------------------------------- OK, étudiant
function boucleJeu()
{
	if( JoueurEnVie == true )
	{
		traiterAction();
		miseAJourLogiqueDuJeu();
	}
	
	afficherElementJeu();	
}
//---------------------------------------------------------------------------------------------- OK étudiant
function traiterAction()
{
	// déplacement gauche/droite
	if (ToucheGaucheEnfoncer)
	{
		ForceX--;
		OrientationJoueur = -1;
	}
	if (ToucheDroiteEnfoncer)
	{
		ForceX++;
		OrientationJoueur = 1;
	}
	
	traiterSaut();
}
//---------------------------------------------------------------------------------------------- OK étudiant
function traiterSaut()
{
	if( ToucheSautEnfoncer )
	{
		if( PositionJoueurCanevasY > 0 && ForceY == 0 )
		{
			ForceY -= VitesseMaximale;
		}
	}
}
//---------------------------------------------------------------------------------------------- OK étudiant
function miseAJourLogiqueDuJeu()
{
	deccelererJoueur();
	limiterVitesse();
	deplacerJoueur();
	verifierCollectionDiamant();
		
	if (PositionJoueurCanevasY + GrosseurTuile > ResolutionY + GrosseurTuile )
		JoueurEnVie = false;
}
//---------------------------------------------------------------------------------------------- OK étudiant
function deccelererJoueur()
{
	if( ToucheGaucheEnfoncer == false && ToucheDroiteEnfoncer == false )
	{
		if (ForceX > 0)
			ForceX -= 0.5;
		if (ForceX < 0)
			ForceX += 0.5;
	}
}
//---------------------------------------------------------------------------------------------- OK étudiant
function limiterVitesse()
{
	if (ForceX > VitesseMaximale)
		ForceX = VitesseMaximale;
	if (ForceX < -VitesseMaximale)
		ForceX = -VitesseMaximale;
		
	if( ForceY > VitesseMaximale )
		ForceY = VitesseMaximale;
	if( ForceY < -VitesseMaximale )
		ForceY = -VitesseMaximale;
}
//---------------------------------------------------------------------------------------------- OK, donner le code de détection
function verifierCollectionDiamant()
{
	var DiamantCollecte = false;
	
	if (DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauHautY] == 5 )
	{ 
		DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauHautY] = -1; 
		DiamantCollecte = true; 
	}
	if (DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauBasY] == 5 )
	{ 
		DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauBasY] = -1; 
		DiamantCollecte = true; 
	}
	if (DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauBasY] == 5 )
	{ 
		DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauBasY] = -1; 
		DiamantCollecte = true; 
	}
	if (DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauHautY] == 5 )
	{ 
		DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauHautY] = -1; 
		DiamantCollecte = true; 
	}

	// les étudiants peuvent faire sa
	if (DiamantCollecte == true)
	{
		Resultat+=10;
		NombreDiamant = NombreDiamant - 1;
		NombreDiamantCollecte = NombreDiamantCollecte + 1;
	}	
}

//---------------------------------------------------------------------------------------------- OK , voir si on donne
function deplacerJoueur()
{	
	//Déplacer le joueur 
	appliquerForce();
	detecterCollision();
	recalculerPositionJoueur();
}
//---------------------------------------------------------------------------------------------- OK , voir si on donne
function appliquerForce()
{
	//appliquer la gravite et les forces pour déplacer le joueur
	ForceY = ForceY + Gravite;
	PositionJoueurCanevasY = PositionJoueurCanevasY + ForceY;
	PositionJoueurCanevasX =  PositionJoueurCanevasX + ForceX;
	recalculerPositionJoueur();	
}
//---------------------------------------------------------------------------------------------- À donner
function recalculerPositionJoueur() // calcul de la position du joueur dans le canvas vs le tableau
{
	PositionJoueurTableauGaucheX = Math.floor( (PositionJoueurCanevasX ) / (GrosseurTuile) ) ; 
	PositionJoueurTableauDroiteX = Math.floor( (PositionJoueurCanevasX ) / (GrosseurTuile) ) + 1; 
	PositionJoueurTableauHautY = Math.floor( PositionJoueurCanevasY / GrosseurTuile );
	PositionJoueurTableauBasY = Math.floor( PositionJoueurCanevasY  / GrosseurTuile ) + 1;
}

//---------------------------------------------------------------------------------------------- OK, code a donner pour les collisions( trop complexe)
function detecterCollision()
{
	recalculerLimitPositionX();
	recalculerPositionJoueur();
	//verifier si il y a collision en X et en Y
	var CollisionEnX = false;
	var CollisionEnY = false;
	
	//CollisionEnX = detecterCollisionEnX();
	CollisionEnX = detecterCollisionEnX();
	CollisionEnY = detecterCollisionEnY();
	
	if( CollisionEnX == true && CollisionEnY == true )
	{
		PositionJoueurCanevasY -= ForceY;
		ForceY = 0;
		PositionJoueurCanevasX -= ForceX;
		ForceX = 0;
	}
	else if( CollisionEnX == true )
	{
		PositionJoueurCanevasX -= ForceX;
		ForceX = 0;
	}
	else if( CollisionEnY == true )
	{
		PositionJoueurCanevasY -= ForceY;
		ForceY = 0;
	}
}
//---------------------------------------------------------------------------------------------- OK, à donner
function recalculerLimitPositionX()
{
	// si le joueur atteint une extremité, le renvoyer dans le jeu
	if (PositionJoueurCanevasX < 0)
	{
		PositionJoueurCanevasX = 0;
		ForceX = -ForceX;
	}
	if (PositionJoueurCanevasX + GrosseurTuile > LargeurNiveau * GrosseurTuile)
	{
		PositionJoueurCanevasX = (LargeurNiveau * GrosseurTuile) - GrosseurTuile;
		ForceX = -ForceX;
	}
}

//----------------------------------------------------------------------------------------------OK, à donner
function detecterCollisionEnY()
{
	if( ForceY < 0 ) 
	{
		if( DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauHautY] > 7 || DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauHautY] > 7 )
			return true;
	}
	else
	{		
		if( DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauBasY] > 7 || DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauBasY] > 7 )
			return true;
	}
	return false;
}
//----------------------------------------------------------------------------------------------OK, à donner
function detecterCollisionEnX()
{	
	var TempPositionJoueurTableauBasY = Math.floor( (PositionJoueurCanevasY-3)  / GrosseurTuile ) + 1;
	// detection de collision en X
	if( ForceX > 0)
	{
		if( DonneeNiveau[PositionJoueurTableauDroiteX][PositionJoueurTableauHautY] > 7 || DonneeNiveau[PositionJoueurTableauDroiteX][TempPositionJoueurTableauBasY] > 7 )
			return true;
	}
	else
	{
		if( DonneeNiveau[PositionJoueurTableauGaucheX][PositionJoueurTableauHautY] > 7 || DonneeNiveau[PositionJoueurTableauGaucheX][TempPositionJoueurTableauBasY] > 7 )
			return true;
	}
	return false;
}


//----------------------------------------------------------------------------------------------OK
function afficherElementJeu()
{
	var context = document.getElementById('canvas').getContext('2d');
	//context.save();
	context.clearRect(0,0,ResolutionX,ResolutionY); 

	afficherFond( context );
	afficherNiveau( context );

	if( OrientationJoueur < 0 )
		context.drawImage( imgJoueurGauche, 0, 10, 32, 38,PositionJoueurCanevasX, PositionJoueurCanevasY, GrosseurTuile, GrosseurTuile);
	else 
		context.drawImage( imgJoueurDroite, 0, 10, 32, 38,PositionJoueurCanevasX, PositionJoueurCanevasY, GrosseurTuile, GrosseurTuile);
 }

//---------------------------------------------------------------------------------------------- Donner
function afficherFond( context )
{
	context.drawImage(TabimgCiel[1],0, 0,ResolutionX,ResolutionY-120 );
	context.drawImage(TabimgCiel[0],0, ResolutionY-320,ResolutionX,320);
}

//---------------------------------------------------------------------------------------------- Code à donner sauf switch
function afficherNiveau( context )
{
	var SolidBlocks = 0;
	
	// Afficher chaque bloc
	var PosCanevasY = 0, PosTableauY = 0, PosCanevasX = 0, PosTableauX =0;
	
	// Parcours dans un tableau en 2 dimension,Fournir le code
	while ( PosCanevasY < ResolutionY )
	{
		PosCanevasX =0;
	    PosTableauX =0;
		
		while ( PosCanevasX < ResolutionX )
		{
			var Tuile = DonneeNiveau[PosTableauX][PosTableauY];
			if (Tuile != -1 && Tuile != GrosseurTuile)
			{
				SolidBlocks++;
				switch( Tuile )
				{
					case 5 :context.drawImage( imgGem, 0, 0, 32, 32, PosCanevasX, PosCanevasY, GrosseurTuile, GrosseurTuile);
							break;
					case 8 :context.drawImage( TabimgTerrain[1], 0, 0, 32, 32, PosCanevasX, PosCanevasY, GrosseurTuile, GrosseurTuile);
							break;
					case 9 :context.drawImage( TabimgTerrain[0], 0, 0, 32, 32, PosCanevasX, PosCanevasY, GrosseurTuile, GrosseurTuile);
							break;
				}
			}
			
			PosCanevasX+=GrosseurTuile;
			PosTableauX++;
		}
		
		PosCanevasY+=GrosseurTuile;
		PosTableauY++;
	}
}
//----------------------------------------------------------------------------------------------Code à donner sauf switch
function chargerNiveau()
{
	Gravite = GraviteCarte;
	var Tuile = 0;
	
	for (var PosYTableau = 0;PosYTableau < HauteurNiveau; PosYTableau++)
	{
		for (var PosXTableau = 0; PosXTableau < LargeurNiveau; PosXTableau++)
		{
			Tuile = InformationNiveau.charCodeAt(PosYTableau * LargeurNiveau + PosXTableau);
			DonneeNiveau[PosXTableau][PosYTableau] = -1;
			
			// étudiant départ
			// case de départ du joueur
			if( Tuile == 49 ) 
			{
				PositionJoueurCanevasX = PosXTableau * GrosseurTuile;
				PositionJoueurCanevasY = PosYTableau * GrosseurTuile;
			}
			
			if ( Tuile >= 65 && Tuile <= 108 )
			{
				//information de a à Z
				DonneeNiveau[PosXTableau][PosYTableau] = Tuile - 65;
				switch( Tuile )
				{
					case 75 : 
						ExitX = PosXTableau;
						ExitY = PosYTableau;
						break;
					case 76 :
						NombreDiamant = NombreDiamant + 1;	
						break;
				}						
			}
			// étudiant fin
			
		}
	}
}


//---------------------------------------------------------------------------------------------- OK, étudiant
function gererToucherEnfoncer(event)
{
	switch(event.keyCode)
    {  
		case 32:
				ToucheSautEnfoncer = true;
				break;
        case 37:
				ToucheGaucheEnfoncer = true;
                break;
        case 39:
				ToucheDroiteEnfoncer = true;
                break; 
    }
}
//---------------------------------------------------------------------------------------------- OK, étudiant
function gererToucherRelacher(event)
{
	switch(event.keyCode)
    {  
		case 32:
				ToucheSautEnfoncer = false;
				break;
        case 37:
				ToucheGaucheEnfoncer = false;
                break;
        case 39:
				ToucheDroiteEnfoncer = false;
                break; 
    }
}


//---------------------------------------------------------------------------------------------- 
</script>
<canvas id="canvas" tabindex="1" width="800" height="600">
Désoler mais ce navigateur ne supporte pas le jeu.
</canvas>

</body>
</html>